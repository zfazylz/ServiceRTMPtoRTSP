# Конвертер RTMP в RTSP

Веб-приложение для конвертации RTMP-потоков в RTSP-потоки с использованием FastAPI и FFmpeg.

## Возможности

- Конвертация RTMP-потоков в RTSP-потоки
- Веб-интерфейс для управления потоками
- Добавление, просмотр и удаление потоков
- RESTful API для программного доступа
- Контейнеризация с Docker для простого развертывания
- База данных SQLite для хранения информации о потоках
- Автоматическая реинициализация потоков при перезапуске приложения

## Требования

- Docker и Docker Compose
- FFmpeg (устанавливается автоматически в Docker)
- Исходные RTMP-потоки

## Быстрый старт

1. Клонируйте этот репозиторий:
   ```bash
   git clone <repository-url>
   cd rtmp-to-rtsp-converter
   ```

2. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

3. Откройте веб-интерфейс по адресу http://localhost:8000

## Использование

### Веб-интерфейс

Веб-интерфейс предоставляет три основные страницы:

1. **Главная страница**: Просмотр всех активных потоков с их деталями
2. **Страница добавления потока**: Добавление нового RTMP-потока для конвертации в RTSP
3. **Удаление потока**: Удаление потока из конвертера

#### Скриншоты веб-интерфейса

![Главная страница](.github/screenshots/Screenshot%202025-05-25%20at%2000.55.28.png)
*Главная страница с потоками*

![Страница добавления потока](.github/screenshots/Screenshot%202025-05-25%20at%2000.55.34.png)
*Форма для добавления нового потока*

### Добавление потока

Чтобы добавить новый поток:

1. Нажмите "Добавить новый поток" на главной странице
2. Введите URL RTMP (должен начинаться с `rtmp://`)
3. Введите уникальное имя для потока (пробелы не допускаются)
4. Укажите порт RTSP (по умолчанию: 8554)
5. Нажмите "Добавить поток"

### Доступ к RTSP-потокам

После добавления потока вы можете получить к нему доступ с помощью любого RTSP-совместимого плеера (например, VLC):

```
rtsp://localhost:ПОРТ/ИМЯ_ПОТОКА
```

Где:

- `ПОРТ` - указанный вами порт RTSP
- `ИМЯ_ПОТОКА` - имя, которое вы дали потоку

Пример:

```
rtsp://localhost:8554/my_stream
```

## Документация API

Приложение предоставляет RESTful API для программного доступа.

### Swagger UI

Для удобства работы с API доступна интерактивная документация Swagger UI:

- **Swagger UI**: [http://localhost:8000/api/docs](http://localhost:8000/api/docs)
- **ReDoc**: [http://localhost:8000/api/redoc](http://localhost:8000/api/redoc)
- **OpenAPI JSON**: [http://localhost:8000/api/openapi.json](http://localhost:8000/api/openapi.json)

![Swagger UI](.github/screenshots/Screenshot%202025-05-25%20at%2000.59.09.png)
*Интерактивная документация Swagger UI для тестирования API*

Swagger UI позволяет:

- Просматривать все доступные API-эндпоинты
- Изучать модели данных и параметры запросов
- Тестировать API-запросы прямо из браузера
- Получать примеры запросов и ответов

### Основные эндпоинты API

#### Получить все потоки

```
GET /api/streams
```

#### Получить конкретный поток

```
GET /api/streams/{stream_name}
```

#### Добавить новый поток

```
POST /api/streams
```

Тело запроса:

```json
{
  "rtmp_url": "rtmp://example.com/live/stream",
  "stream_name": "my_stream",
  "rtsp_port": 8554
}
```

#### Удалить поток

```
DELETE /api/streams/{stream_name}
```

## Сохранение потоков

Приложение использует SQLite для хранения информации о потоках, обеспечивая их сохранение даже при перезапуске
приложения. При запуске приложение автоматически загружает все сохраненные потоки из базы данных и перезапускает их.

### Расположение базы данных

База данных SQLite хранится в директории `data` в корне проекта. В Docker эта директория монтируется как том для
обеспечения сохранности данных при перезапуске контейнера.

## Устранение неполадок

### Проблемы с RTSP-потоками

Если у вас возникают проблемы с RTSP-потоками, попробуйте следующие решения:

#### Использование режима сетевого хоста

1. Отредактируйте `docker-compose.yml`
2. Раскомментируйте строку `network_mode: host`
3. Закомментируйте секцию `ports`
4. Перезапустите приложение:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

#### Настройка имени хоста для RTSP URL

По умолчанию приложение использует `localhost` в RTSP URL. Если вы получаете доступ к приложению с другого компьютера,
вам может потребоваться изменить имя хоста:

1. Отредактируйте `docker-compose.yml`
2. Измените значение переменной окружения `HOSTNAME`:
   ```yaml
   environment:
     - HOSTNAME=your-server-ip-or-hostname
   ```
3. Перезапустите приложение:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

### Ошибки FFmpeg

Если вы видите ошибки FFmpeg в логах, проверьте:

1. URL RTMP корректен и доступен
2. RTMP-поток активен и работает
3. Порт RTSP не используется другим приложением

### Проблемы с базой данных

Если у вас возникают проблемы с сохранением потоков:

1. Проверьте, что директория `data` существует и доступна для записи
2. Убедитесь, что файл базы данных SQLite (`data/streams.db`) существует
3. Если используете Docker, убедитесь, что том правильно смонтирован

![Структура базы данных](.github/screenshots/Screenshot%202025-05-25%20at%2000.59.09.png)
*Просмотр структуры и содержимого базы данных SQLite*

## Разработка

### Запуск в режиме разработки

Для запуска приложения в режиме разработки:

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

2. Запустите приложение:
   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

### Структура проекта

Проект имеет модульную структуру:

```
app/
├── __init__.py          # Инициализация приложения FastAPI
├── main.py              # Точка входа в приложение
├── config.py            # Конфигурация приложения
├── db.py                # Совместимость с устаревшим API базы данных
├── api/                 # API эндпоинты
│   ├── __init__.py
│   └── streams.py       # API для управления потоками
├── web/                 # Веб-интерфейс
│   ├── __init__.py
│   └── routes.py        # Маршруты веб-интерфейса
├── models/              # Модели данных Pydantic
│   ├── __init__.py
│   └── stream.py        # Модели для валидации данных потоков
├── database/            # Работа с базой данных
│   ├── __init__.py
│   ├── models.py        # SQLAlchemy модели
│   ├── session.py       # Управление сессиями БД
│   └── crud.py          # CRUD операции
├── converter/           # Конвертация потоков
│   ├── __init__.py
│   ├── stream_converter.py  # Конвертер потоков
│   ├── logger/          # Логирование
│   │   ├── __init__.py
│   │   └── writer.py    # Запись логов
│   └── manager/         # Управление потоками
│       ├── __init__.py
│       └── stream_manager.py  # Менеджер потоков
├── static/              # Статические файлы
│   └── logs/            # Логи потоков
└── templates/           # HTML шаблоны
    ├── base.html        # Базовый шаблон
    ├── index.html       # Главная страница
    ├── add_stream.html  # Страница добавления потока
    └── stream_logs.html # Страница просмотра логов
```

### Архитектура приложения

Приложение построено на основе следующих компонентов:

1. **FastAPI** - веб-фреймворк для создания API и веб-интерфейса
2. **SQLAlchemy** - ORM для работы с базой данных SQLite
3. **Pydantic** - валидация данных и сериализация
4. **Jinja2** - шаблонизатор для веб-интерфейса
5. **FFmpeg** - утилита для конвертации медиа-потоков

Основные компоненты приложения:

- **StreamConverter** - класс для конвертации одного RTMP-потока в RTSP
- **StreamManager** - класс для управления несколькими конвертерами потоков
- **API эндпоинты** - RESTful API для программного управления потоками
- **Веб-интерфейс** - пользовательский интерфейс для управления потоками
- **База данных** - хранение информации о потоках

## Лицензия

Этот проект лицензирован под лицензией MIT - см. файл LICENSE для подробностей.
